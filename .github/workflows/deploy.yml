name: Deploy to Azure

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy-all:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ==========================================
      # CLEANUP EXISTING RESOURCES
      # ==========================================
      - name: Delete Existing Resources
        shell: powershell
        run: |
          Write-Host "üîç Checking for existing resources..."

          # Check App Service Plan
          Write-Host "`nChecking App Service Plan..."
          az appservice plan show --name photoapi-plan --resource-group rg-group1-sch --query "name" -o tsv 2>$null | Out-Null

          if ($LASTEXITCODE -eq 0) {
              Write-Host "‚úÖ App Service Plan EXISTS - will delete it"
              az appservice plan delete --name photoapi-plan --resource-group rg-group1-sch --yes
              Write-Host "‚úÖ App Service Plan deleted"
          } else {
              Write-Host "‚ÑπÔ∏è App Service Plan does NOT exist - nothing to delete"
          }

          # Check App Service
          Write-Host "`nChecking App Service..."
          az webapp show --name photoapi-app --resource-group rg-group1-sch --query "name" -o tsv 2>$null | Out-Null

          if ($LASTEXITCODE -eq 0) {
              Write-Host "‚úÖ App Service EXISTS - will delete it"
              az webapp delete --name photoapi-app --resource-group rg-group1-sch
              Write-Host "‚úÖ App Service deleted"
          } else {
              Write-Host "‚ÑπÔ∏è App Service does NOT exist - nothing to delete"
          }

          Write-Host "`n‚úÖ Resource check complete"
      
      # ==========================================
      # INFRASTRUCTURE (Terraform)
      # ==========================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.7.0
      
      - name: Terraform Init
        working-directory: ./infra
        shell: powershell
        run: terraform init
      
      - name: Terraform Plan & Apply
        working-directory: ./infra
        shell: powershell
        run: |
          terraform plan
          terraform apply -auto-approve
      
      # ==========================================
      # APPLICATION DEPLOYMENT
      # ==========================================
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
        env:
          DOTNET_INSTALL_DIR: C:\actions-runner\dotnet
      
      - name: Build .NET Project
        run: dotnet publish ./src/HelloWorldApi/HelloWorldApi.csproj -c Release -o ./publish
      
      - name: Deploy to Azure
        shell: powershell
        run: |
          Compress-Archive -Path ./publish/* -DestinationPath ./publish.zip -Force
          
          az webapp deploy `
            --name photoapi-app `
            --resource-group rg-group1-sch `
            --src-path "./publish.zip" `
            --type zip