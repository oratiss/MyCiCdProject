name: Terraform + .NET Deploy via Self-Hosted Runner

on:
  push:
    branches: [ "main" ]

jobs:
  # ------------------------------
  # 1️⃣ Check Terraform version
  # ------------------------------
  check-terraform-version:
    runs-on: self-hosted
    steps:
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.7.0

      - name: Verify Terraform version
        run: terraform version

  # ------------------------------
  # 2️⃣ Terraform Infrastructure
  # ------------------------------
  terraform:
    runs-on: self-hosted
    needs: check-terraform-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.7.0

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        working-directory: ./infra
        run: terraform init

      - name: Import existing App Service Plan and App Service
        working-directory: ./infra
        shell: powershell
        run: |
          Write-Host "Checking if App Service Plan exists..."
          $planExists = ""
          try {
            $planExists = az appservice plan show `
              --name photoapi-plan `
              --resource-group rg-group1-sch `
              --query "name" -o tsv 2>$null | Out-String
          } catch {
            Write-Host "Warning suppressed: $_"
          }

          if ($planExists.Trim()) {
            Write-Host "✅ Importing existing App Service Plan..."
            terraform import azurerm_app_service_plan.plan "/subscriptions/18a54fef-d36d-4d1c-b7b4-c468a773149b/resourceGroups/rg-group1-sch/providers/Microsoft.Web/serverfarms/photoapi-plan"
          } else {
            Write-Host "ℹ️ App Service Plan does not exist — will be created by Terraform."
          }

          Write-Host "Checking if App Service exists..."
          $appExists = ""
          try {
            $appExists = az webapp show `
              --name photoapi-app `
              --resource-group rg-group1-sch `
              --query "name" -o tsv 2>$null | Out-String
          } catch {
            Write-Host "Warning suppressed: $_"
          }

          if ($appExists.Trim()) {
            Write-Host "✅ Importing existing App Service..."
            terraform import azurerm_app_service.app "/subscriptions/18a54fef-d36d-4d1c-b7b4-c468a773149b/resourceGroups/rg-group1-sch/providers/Microsoft.Web/sites/photoapi-app"
          } else {
            Write-Host "ℹ️ App Service does not exist — will be created by Terraform."
          }

      - name: Terraform Plan & Apply
        working-directory: ./infra
        run: |
          terraform plan
          terraform apply -auto-approve

  # ------------------------------
  # 3️⃣ .NET Build + Deploy
  # ------------------------------
  build-and-deploy:
    runs-on: self-hosted
    needs: terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
        env:
          DOTNET_INSTALL_DIR: C:\actions-runner\dotnet

      - name: Build project
        run: dotnet publish ./src/HelloWorldApi/HelloWorldApi.csproj -c Release -o ./publish

      - name: Deploy using Publish Profile
        env:
          PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        run: |
          az webapp deploy `
          --name photoapi-app `
          --resource-group rg-group1-sch `
          --src-path "./publish" `
          --type zip `
          --publish-profile "$env:PUBLISH_PROFILE"
