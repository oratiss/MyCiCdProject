name: Build & Deploy .NET (self-hosted)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
        env:
          DOTNET_INSTALL_DIR: C:\actions-runner\dotnet

      - name: Build & publish
        run: dotnet publish ./src/HelloWorldApi/HelloWorldApi.csproj -c Release -o ./src/HelloWorldApi/bin/Release/net9.0/publish

      - name: Validate publish folder
        run: |
          if (-not (Test-Path -Path "src/HelloWorldApi/bin/Release/net9.0/publish")) { 
            Write-Error "Publish folder not found"; exit 1 
          }
        shell: powershell

      - name: Deploy using Publish Profile
        env:
          PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        run: |
          az webapp deploy `
            --name photoapi-app `
            --resource-group rg-group1-sch `
            --src-path "src/HelloWorldApi/bin/Release/net9.0/publish" `
            --type zip `
            --timeout 1800 `
            --publish-profile "$env:PUBLISH_PROFILE"
        shell: powershell
