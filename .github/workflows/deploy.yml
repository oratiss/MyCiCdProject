name: Deploy to Azure

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy-all:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ==========================================
      # CLEANUP EXISTING RESOURCES
      # ==========================================
      - name: Delete Existing Resources
        shell: powershell
        run: |
          Write-Host "🗑️ Checking for existing resources to delete..."
          
          # Delete App Service first (depends on plan)
          $appExists = $null
          try {
            $appExists = az webapp show `
              --name photoapi-app `
              --resource-group rg-group1-sch `
              --query "name" -o tsv 2>$null
          } catch {}
          
          if ($appExists) {
            Write-Host "Deleting App Service..."
            az webapp delete --name photoapi-app --resource-group rg-group1-sch
            Write-Host "✅ App Service deleted"
          }
          
          # Delete App Service Plan
          $planExists = $null
          try {
            $planExists = az appservice plan show `
              --name photoapi-plan `
              --resource-group rg-group1-sch `
              --query "name" -o tsv 2>$null
          } catch {}
          
          if ($planExists) {
            Write-Host "Deleting App Service Plan..."
            az appservice plan delete --name photoapi-plan --resource-group rg-group1-sch --yes
            Write-Host "✅ App Service Plan deleted"
          }
          
          Write-Host "🎯 Cleanup complete - ready for Terraform"
      
      # ==========================================
      # INFRASTRUCTURE (Terraform)
      # ==========================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.7.0
      
      - name: Terraform Init
        working-directory: ./infra
        shell: powershell
        run: terraform init
      
      - name: Terraform Plan & Apply
        working-directory: ./infra
        shell: powershell
        run: |
          terraform plan
          terraform apply -auto-approve
      
      # ==========================================
      # APPLICATION DEPLOYMENT
      # ==========================================
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
        env:
          DOTNET_INSTALL_DIR: C:\actions-runner\dotnet
      
      - name: Build .NET Project
        run: dotnet publish ./src/HelloWorldApi/HelloWorldApi.csproj -c Release -o ./publish
      
      - name: Deploy to Azure
        shell: powershell
        run: |
          Compress-Archive -Path ./publish/* -DestinationPath ./publish.zip -Force
          
          az webapp deploy `
            --name photoapi-app `
            --resource-group rg-group1-sch `
            --src-path "./publish.zip" `
            --type zip