name: Terraform + .NET Deploy via Self-Hosted Runner

on:
  push:
    branches: ["main"]

jobs:
  terraform:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.7.0

      - name: Verify Terraform installation
        run: terraform version

      - name: Terraform Init
        working-directory: ./infra
        run: terraform init

      - name: Import existing App Service Plan and App Service
        working-directory: ./infra
        shell: powershell
        run: |
          # Import App Service Plan if it exists
          $planExists = az appservice plan show `
            --name photoapi-plan `
            --resource-group rg-group1-sch `
            --query "name" -o tsv 2>$null
          if ($planExists) {
            Write-Host "Importing existing App Service Plan..."
            terraform import azurerm_app_service_plan.plan "/subscriptions/18a54fef-d36d-4d1c-b7b4-c468a773149b/resourceGroups/rg-group1-sch/providers/Microsoft.Web/serverfarms/photoapi-plan"
          }

          # Import App Service if it exists
          $appExists = az webapp show `
            --name photoapi-app `
            --resource-group rg-group1-sch `
            --query "name" -o tsv 2>$null
          if ($appExists) {
            Write-Host "Importing existing App Service..."
            terraform import azurerm_app_service.app "/subscriptions/18a54fef-d36d-4d1c-b7b4-c468a773149b/resourceGroups/rg-group1-sch/providers/Microsoft.Web/sites/photoapi-app"
          }

      - name: Terraform Plan & Apply
        working-directory: ./infra
        run: |
          terraform plan
          terraform apply -auto-approve

  build-and-deploy:
    runs-on: self-hosted
    needs: terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
        env:
          DOTNET_INSTALL_DIR: C:\actions-runner\dotnet

      - name: Build project
        run: dotnet publish ./src/HelloWorldApi/HelloWorldApi.csproj -c Release -o ./publish

      # Deploy using Publish Profile instead of SP login
      - name: Deploy to Azure via Publish Profile
        uses: azure/webapps-deploy@v2
        with:
          app-name: "photoapi-app"
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: "./publish"
